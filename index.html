<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Alumina CNC</title>
    <style>
      html, body { margin: 0; height: 100%; }
      canvas { width: 100%; height: 100%; touch-action: none; }
    </style>
  </head>
  <body>
    <canvas id="alumina_canvas"></canvas>
    <script type="module">
      /* ── generic loader for a .js.gz file ───────────────────────────── */
      async function importGzJs(path) {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`cannot fetch gzip JS: ${path}`);

        let jsBytes;
        if (res.headers.get("content-encoding")?.includes("gzip")) {
          // server already decoded for us
          jsBytes = new Uint8Array(await res.arrayBuffer());
        } else if (globalThis.DecompressionStream) {
          // client-side decode
          const ds  = new DecompressionStream("gzip");
          const buf = await new Response(res.body.pipeThrough(ds)).arrayBuffer();
          jsBytes   = new Uint8Array(buf);
        } else {
          throw new Error("no gzip support in this browser");
        }

        /* turn the decompressed source into an ES module */
        const blobURL = URL.createObjectURL(
          new Blob([jsBytes], { type: "text/javascript" }),
        );
        return import(blobURL);
      }

	  /* ── helper for Brotli-compressed WASM ────────────────────────── */
	  async function fetchBrWasm(path) {
	    const res = await fetch(path);
	    if (!res.ok) throw new Error(`cannot fetch Brotli WASM: ${path}`);

	    /* server already decoded? */
	    if (res.headers.get("content-encoding")?.includes("br")) {
		  return new Uint8Array(await res.arrayBuffer());
	    }

	    /* client-side decode via DecompressionStream("brotli") */
	    if (globalThis.DecompressionStream) {
		  try {
		    const ds  = new DecompressionStream("brotli");
		    const buf = await new Response(res.body.pipeThrough(ds)).arrayBuffer();
		    return new Uint8Array(buf);
		  } catch (_) {/* fallthrough */ }
	    }

	    throw new Error("no Brotli support (server or browser)");
	  }

	  /* ── main entry point ──────────────────────────────────────────── */
      async function run() {
        /* 1) grab the JS glue code (gzipped) */
        const { default: init, start } =
          await importGzJs("./alumina-ui.js.gz");

        /* 2) fetch & decode the Brotli-compressed WASM */
        const wasmBytes = await fetchBrWasm("./alumina-ui_bg.wasm.br");

        /* 3) hand the bytes to wasm-bindgen’s init(), then start the app */
        await init(wasmBytes);
        start("alumina_canvas");
      }

      run().catch(console.error);
    </script>
  </body>
</html>
